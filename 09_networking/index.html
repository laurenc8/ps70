<!DOCTYPE html>
<html lang="en">

<title>PS70: Intro to Digital Fabrication </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../style.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/arduino-light.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/arduino.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script> 

<div id="header">
    <iframe src="../head.html"  style="border: none;" width="100%" height="180px;" scrolling="no" ></iframe>
</div>

<h1  style="text-align: center">Radio, WiFi, Bluetooth (IoT)</h1>

<br>
<br>
<br>
<br>
<br>

<div class="row">
	<div class="small-1 medium-1 large-1 small-centered columns">
		<ul class="small-block-grid-1 medium-block-grid-1 large-block-grid-1 inline-list-custom">

			<li>
                    
                <pre style="text-align: left; height: 400px; overflow: scroll;"><code class="language-arduino">
#include &lt;Arduino.h&gt;
#include &lt;WiFi.h&gt;
#include &lt;Firebase_ESP_Client.h&gt;

// Provide the token generation process info.
#include "addons/TokenHelper.h"
// Provide the RTDB payload printing info and other helper functions.
#include "addons/RTDBHelper.h"

// Network credentials
#define WIFI_SSID REPLACE_WITH_YOUR_OWN
#define WIFI_PASSWORD REPLACE_WITH_YOUR_OWN

// Firebase project API Key
#define API_KEY REPLACE_WITH_YOUR_OWN

// Define the RTDB URL */
#define DATABASE_URL REPLACE_WITH_YOUR_OWN

//Define Firebase Data object
FirebaseData fbdo;

FirebaseAuth auth;
FirebaseConfig config;

class Ultrasonic {
    public:
    int trigPin;
    int echoPin;
    int signalInterval;
    unsigned long signalStartTime = 0;
    int measured = 3;
    long duration;

    Ultrasonic(int pin1, int pin2, int interval) {
        trigPin = pin1;
        echoPin = pin2;
        signalInterval = interval; // in microseconds
        pinMode(trigPin, OUTPUT);
        pinMode(echoPin, INPUT);
    }

    void sendSignal() {
        if ((micros() - signalStartTime > signalInterval) && (measured == 3)) {
            signalStartTime = micros();
            digitalWrite(trigPin, LOW); // Set the Trigger pin LOW to start a pulse
            measured = 2;
        }
        else if ((micros() - signalStartTime > 2) && (measured == 2)) {
            digitalWrite(trigPin, HIGH); // Set the Trigger pin HIGH
            measured = 1;
        }
        else if ((micros() - signalStartTime > 12) && (measured == 1)) {
            digitalWrite(trigPin, LOW); // Set the Trigger pin LOW again to complete the pulse
            measured = 0; // Signal is done so ready to measure
        }
    }

    void measureSignal() {
        if (measured == 0) {
            duration = pulseIn(echoPin, HIGH); // Listen for a pulse on the Echo pin
            Serial.print("Duration: ");
            Serial.println(duration);
            measured = 3;
        }
    }
};

Ultrasonic ultrasonic(D9, D2, 10000);

unsigned long sendDataPrevMillis = 0;
bool signupOK = false;

void setup(){
    Serial.begin(115200);
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    Serial.print("Connecting to Wi-Fi");
    while (WiFi.status() != WL_CONNECTED){
        Serial.print(".");
        delay(300);
    }
    Serial.println();
    Serial.print("Connected with IP: ");
    Serial.println(WiFi.localIP());
    Serial.println();

    /* Assign the api key (required) */
    config.api_key = API_KEY;

    /* Assign the RTDB URL (required) */
    config.database_url = DATABASE_URL;

    /* Sign up */
    if (Firebase.signUp(&config, &auth, "", "")){
        Serial.println("ok");
        signupOK = true;
    }
    else{
        Serial.printf("%s\n", config.signer.signupError.message.c_str());
    }

    /* Assign the callback function for the long running token generation task */
    config.token_status_callback = tokenStatusCallback; //see addons/TokenHelper.h
    
    Firebase.begin(&config, &auth);
    Firebase.reconnectWiFi(true);
}

void loop(){
    if (Firebase.ready() && signupOK){
        ultrasonic.sendSignal();
        ultrasonic.measureSignal();

        // Write the duration to the database path ultrasonic
        if (Firebase.RTDB.setInt(&fbdo, "ultrasonic", ultrasonic.duration)){
        } else {
            Serial.println("FAILED");
            Serial.println("REASON: " + fbdo.errorReason());
        }
    }
}
                </code></pre>
			</li>

		</ul>
	</div>
</div>

</html>